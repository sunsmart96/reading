# DEVOPS实践指南

这本书主要 讲软件从开发测试到部署的流程化，尤其在公司多个团队开发一个复杂功能软件，存在大量版本冲突，测试不充分，部署环境困难等问题。这都是DEVOPS这个领域要解决的问题。 这些也是任何软件技术方向工程师每天工作都要接触面对的。

就我个人经历而言，在国内，互联网大厂比如百度阿里腾讯字节这种公司，devops基建是比较成熟的，而且这些大厂都是自己内部研发的devops平台(最次也是改进开源项目的)。尤其一些部门对代码质量有更为严格的要求，会在devops中加入大量测试工具。来规范代码和保证代码质量。而在一些创业公司，devops的实践就没有那么完善了。很多公司甚至都没有devops的概念，开发环境的配置甚至都没有文档可以查询，完全口口相授，十分落后，整个软件开发过程中的协作效率也非常低。就我个人而言，在没进互联网大厂前也工作了三年了，所在的公司全部没有devops的基建，代码质量完全看团队。同一个公司，如果一个团队技术主管在内部管理严格，整体代码质量就会比较高，而如果主管自己都没有这种概念，那写出来的代码就是一锅粥，没完没了的bug不断，甚至一些研发以开发完一个功能，解决bug多为荣。代码可维护性可测试性极差，稍微改动就会蹦出来一堆奇奇怪怪坏的问题。

这也凸显了devops平台建设的好坏，是会非常影响软件质量和产品交付质量速度的。国内普遍的做法就是无脑加工作时间，玩命加班解决，但是其实很多时候只要稍加分析，就可以发现很多加班只是方法不正确，使用错误开发模式导致的。而且即使加班去修复bug，也都是暂时的顶一下，并不是从根本解决问题。

更有甚者团队开发，每个人配置的库版本环境都不一样，出了问题甚至都复现不了。

所以良好的devops平台，对于研发测试部署相关工作的同学，都可以极大地提高工作效率和输出质量。而且团队越大，开发的软件越复杂，有效的devops平台所带来的收益越大。

这几年到处都在裁员，都在讲降本增效，实际上如果你去任何一家稍微有点规模的科技公司，在一线跟一跟，就会发现工作中存在大量低效的问题在消耗掉大量的工作时间，搞得很多人下班不能回家，企业研发经费高的离谱，进而整个公司连基本的盈利都做不到。都在无效的卷，最后产品不行，在市场上消费者不买账，最后整个公司走向崩溃。

就我而言，我一直主张搭建高效的技术团队，原则上人数能越少越好，但是人少，如何才能做到常规只能用我们团队人数数倍的规模团队才能做到的事情呢？单纯的加班不会带来明显的产出提升，而且如果长期加班，每个人的效率其实会降低。这样的制度反而会变成一种折磨人的制度。也就是现在很普遍的无效地卷。

所以核心还是在于提高生产力，比如高效的沟通工具，这里的沟通不是局限于个人沟通技巧的沟通，而是能够让团队成员任何一个人都可以在项目中即使有效的把信息传递到合适的人身上，是大量低效而重复的事情，不需要每个人都在上面浪费一遍甚至更多的时间。这个事情很重要，我在实践过程中就发现，很多职场上的人，特别喜欢让别人也踩自己踩过的坑，这样做就凸显出他其他人也没有比自己更优秀，但是从团队整体的角度，这样做无疑是低效的。甚至在一些公司团队，你正常提出一些问题都会被当做故意跟对别人，他可以有问题，但是你不能提，否则就记恨你。如果这种行为大量存在，一个团队又如何保持高效呢？这不成了劣币驱逐良币了嘛？但是现实就是这样事情每天都在上演。而这一些列的做法都是在给产品项目挖坑。我判断一个团队导致有没有潜力的一个依据，从来不是他们融资了多少钱，也不是他们有多少有背景的大人物，而是一个团队对于存在的错误多大的敏感性和快速改进的能力。因为现实中不存在完美无缺的团队，所有团队都有问题，核心就在于你解决问题的成本和力度。就像我前面说的，如果一个公司里面充满那种给人挖坑的人，这种团队想要达到我的团队建设目标比登天还难。不狠狠地清洗一遍基本没法改造，只能组建新的团队从头搭建。

所以devops正是我苦苦寻找能够提高软件团队效能产出的最核心的法宝。当然devops本身也在发展进步，比如2023年以前，AI很少进入到devops里面，即使有也是作为测试工具来提升一些领域测试效能的。而随着chatgpt横空出世，一个团队如果能够在日常软件开发中使用上先进的AI大模型，那开发效率直接翻倍。虽然没有权威的定义说devops就一定包含我所说的code copilot。当然大模型能做的事情肯定不仅仅是copilot，随着大模型应用的发展，会出现越来越多的新应用融入到devops这种软件效能流程中，未来一个十几个人的团队搞营收几个亿的公司真的不是科幻。

devops平台的核心目标是围绕产品，从产品经理到研发、qa、运维、信息安全等整个it产品产生的所有岗位部门高效协作，快速迭代，且可以保证代码和交付质量。可以随时对新的代码提交进行验证且形成稳定可交付版本。当然更广义的devops不止局限于代码，也可以包含更多的因素进来。

devops提出来的初衷是因为软件产品具有快速变化的特性，那么如果能够快速将软件新的特性形成一个稳定的可发布版本，快速投入市场，就可以尽早得到用户反馈。因为大型软件都是很多团队协作完成的，每个团队都只负责一部分，但是给客户呈现的是一个完整的软件，任何一个部分出现致命问题都会影响用户体验。所以不能等到各个部分都开发完再去合并部署测试，因为这样做就会导致反馈的时间变长，而且不同部门会出现代码冲突。测试也会不完善。如果出现上述问题，再花大量时间磨合解决，新的一次合并部署，可能还会存在一堆问题。这就导致整个产品不论是研发还是部署，都没办法给出一个稳定版本可以拿来使用。另外再部署软件阶段，因为需要配置相关软件执行环境，但是环境是伴随着软件演化变动的，这就存在大量潜在风险。就会出各种稀奇古代的问题。耗费大量精力。

而有了良好的devops平台，构建代码的环境都是标准的，所有人都是一样的，就消除了不同人自己开发环境不同导致版本环境导致的问题。而且像用c++软件开发的大型项目，通过统一的流水线构建，还可以配置单元测试，各种代码检测工具，对代码可以有更为科学和有力的掌控力。与此同时，代码的部署环境，也可以通过使用容器技术，避免不同软件版本环境的干扰。而代码部署的频次可以从不使用devops时几天甚至几周变成每天数次甚至每天上千次。有任何问题都可以快速得到反馈。

书中提出一种概念叫做技术债务。就是在原本的产品开发中，为了快速上线，代码质量快速下降，不断在各个技术层面挖坑埋雷，结果越往后功能越复杂，代码越难维护。这就是欠下技术债的过程。而在中国，这种事情每天都在大量发生。而更多的研发，在公司从来不会想去解决，而是通过加班让系统变得更加脆弱。反正产品和老板不会查代码，他们过两年在哪哪个公司还不知道呢，谁管着代码到底会烂成什么样子呢？而在公司中有话语权的人物一般也不会太在意代码怎么样，如果是技术出身尤其受到过良好教育背景或者在很知名企业工作过也许还会注意一些，否则更没人在意。这种技术债在初期并不显眼，但是随着代码量增加，1功能越来越多越来越负责，就逐渐趋向于失控。如果这种时候还不注意单元测试等这种测试的添加，代码就彻底烂掉了。这时候再换人重构，员工继续加班，公司的产品进度也被耽误着。整个过程其实公司的时间金钱损耗都很大。

中国很多人都喜欢做管理，尤其喜欢那种侵犯他人尊严或者人权的行为，这样会让这些管理者有一种异样的快感。但是他们只是喜欢这种不把人当人的方式，并不真正懂得管理。他们以为管理就是自己能够去支配别人的时间行为甚至尊严，而真正的管理是为了整个团队能够达到目标，通过技术手段构建敏感的问题感知，高效信息流通、科学的决策、果断的执行力配套的体系。管理的核心不在于某些人高高在上，下面的人唯唯诺诺拍马屁逢迎，而是真正让所有人都高效的工作，让工作的成功给所有人带来成就感和足够的收益。

因为很多管理者压根不懂得管理，他们只是所见即所得的认为降本增效就是裁员，活着把正式员工替换成外包，就可以了，因为他们从来不亲临一线，从来不在一线体验到底哪里出了问题。他们甚至都不知道到底哪些问题是造成组织低效的主要原因。这是社会资源的一种错误配置。为什么这样的人要去带领队伍？为什么大量这样的人带领队伍？这就是一个社会制度性问题。为什么这样的错误不能快速地把这些人淘汰掉？

devops本质并不复杂，只要掌握一点即可，就是用尽各种办法让软件中存在的问题能够快速精准的反馈到相关人手中。不论是产品，研发，测试，还是运维，安全。书里面说的各种原则技术方法都是围绕这一点展开的。从产品产生一个想法到最终想法以软件的形式交付到客户手中为止。软件产品的核心价值是服务客户。而整个devops就是为了更加高效稳健完成这个流程而存在的。

# 1.基本原则
devops基本原则是书中前四章主要讲的内容。也就是流动，反馈和持续学习实验。整体跟自动控制系统非常类似。

流动的意思就是说从产品到研发测试运维部署，不要等上游完成一个非常大的改动，他们完全做完之后再向下流动。比如说一个季度的开发任务等研发都开发完，测试再进行测试，测试完再进行部署。这就类似于瀑布模型，这样做，改动太大，反馈的时间和链路都会比较长，产生的问题也会很多。所以应该将大的任务进行拆分分解成一些相互独立的，以更小的粒度进行流动。比如开发开发完一个feature就进行单元测试和各种qa的测试，之后就进行部署，这样可以快速反馈出问题并快速解决。与此同时，要保证流水线上相关的人每个人都不要同时做多件事情。因为同时做多件事情的结果就是每件事情都做不好。

在书中作者把困扰系统高效运行的问题称为约束点，跟优化理论的术语差不多意思。这正是我前面说的核心问题。只不过我说的更宽泛一点，而作者更偏向代码相关。

主要也就是几个方面：环境搭建、代码部署、测试准备与执行、紧密耦合架构

反馈的意思也很简单，就是出现问题可以把问题快速精准流通到合适的人手中快速解决。这样可以尽可能早的把问题留在研发测试阶段暴露出来加以解决而不是等发布后造成重大损失才去解决。没有任何人可以在复杂系统中设计出绝对安全的系统，所以工程的核心是要尽可能早，尽可能快速地在问题刚有苗头就解决掉。所以反馈系统要配合完善的监测系统来使用。在代码层面最重要的手段就是测试，执行自动化测试，去测试算法代码的边界和corner case。并且要保证足够高的代码覆盖率。缺乏足够测试的代码是没有任何质量可言了。

持续学习和实践。这在中国尤其一些私企简直是稀有物种。像字节跳动的一些负责人甚至能说出来人才是不需要培养的，从他们对人才的态度就可以推断出他们对待组织学习能力和成长的态度。至少在中国高科技企业里面，存在大量完全忽视组织学习的。他们甚至能干出来为了套取新员工方案，招聘进来，设置6个月试用期，榨干价值就直接试用期不给转正这种事情。他们能让你在工作中学习成长那更是天方夜谭。他们永远是短视，仅仅以眼前最直观的方式去快速完成价值榨取然后抛弃掉换新人，类似于白嫖的手段来补充团队的能力。但是这种事情做多了，其他员工也在看，你觉得他们平时工作会真心实意帮助系统进行改进发展了吗？会不会为了防止被公司这样手段套路四处挖坑埋雷呢？

在2024这个年代，没有任何一个人可以说仅仅凭借之前学习的内容就可以在社会上发展很好了。都需要学习新的知识，因为社会发展变化很快。所以一个员工如果有超强的学习能力，是公司的财富。这样的员工只要稍加培养，就可以在很多方面为公司创造出超额的价值。但是我最近几年再国内看到的情况是，很多地方过分片面的要求员工具备某种经验。这在社会经济大环境不好的情况下，本来也算无可厚非嘛，企业想要进来的人来了就可以干活。但是直接以某种经验是否有就卡人的方式是欠妥的。就像我这里说的学习能力非常强的人，是完全有能力在短期就在一个新的方向创造出大量价值的，在这种情况下，如果单纯按照经验去卡人，招到的所谓有经验的人，很可能出来这块经验领域之外，在其他的领域是没有办法给公司带来超额的价值的。我并不是否认经验价值的意义和作用，一个团队做一个方向，必然需要有经验的人，防止踩坑，但是我反对的是过于强调，因为这种价值导向就会让大家都固守在自己的一个小圈子里面，看起来很专业很有经验，但是一旦跨出这个圈子，就完全没有能力输出了，这对于个人发展和企业发展都是非常致命的。这意味着你最多只能在几年的时间跨度内创造价值，等这个封口过去，完全没人要了，企业也是如此，任何一个方向都存在一个市场规模的限制，就算你专精到世界第一，市场规模就那么大，新的科技创新可以完全颠覆你之前苦心经营数十年的产业。因此相比于经验，学习能力创新能力才是立足于未来发展的更重要的能力资源。

有一个段子说一个工人，突发奇想，设计了一个装置，可以替代掉大量工厂的劳动力。结果老板知道后，把这个工人和其他干这个活的都开了。这就是中国典型的管理思维。新的装置替换掉大量人力不假，把多余的人力用机器替换掉也是人之常情，在商言商也无可厚非，但是为神秘不把当初进行创新的人留下呢？为什么不培养一下呢？你这样赶尽杀绝之后，那些知道公司存在问题甚至有解决方案的人，还会还敢提出来么？为什么不把这个创新的人做成典型去鼓励创新呢？

而且中国老板或者管理层普遍存在一种奴隶主思想，就是不管赚钱不赚钱，反正不能看到员工闲下来，员工不把所有工作时间用在公司安排的活上就是工作不饱和。试问如果把员工的工作时间全部都消耗在这个上面，甚至还要加班，他们怎么学习，有时间思考嘛？有怎么创新呢？

没有学习，没有思考，没有创新，纯纯的搬砖，还要去搞高科技除了抄袭，还能做什么呢？

在员工的工作时间中，预留20%的时间用于自由安排，思考是合理的。一个有反省，创造力的团队远远强于一个只知道机械执行的团队。而且这些机械执行的团队执行效率也不高经常出现推诿的问题。有些老板可能会觉得培养员工，那员工离职了，不就白培养了嘛。甚至员工跑到竞争对手那边，岂不是养虎为患？还不如直接榨取，用完就扔。就我自身经历而言，中国绝大多数公司甚至可以说几乎所有公司压根做不到我所说的这种做事体系效率和模式。他们跳槽过去肯定会自己的薪水有所上涨，但是在那个环境他们想复刻类似的体系几乎是不可能的。员工把工作仅仅当做赚钱的手段没问题，但是如果仅仅如此，必定没办法有大发展。因为大发展需要更多的思考，需要破除更多的阻碍，甚至需要冒险。因此离开的员工大多数并不能在新公司获得在原来高效团队所带来的那种体验感，而且高效率团队因为人均高效，产品的成本反而更低，产品会更有竞争力，原团队经过一系列正当竞争是有非常高的概率获得比较高的薪水的。即使被挖走了一些骨干，他们在新公司受制于老板思想跟不上最新发展趋势，也不会发展的太好。中国基层员工的能力负责程度以及对待工作的态度已经是世界最好的了，但是中国的产品尤其高科技产品基本以抄袭和低价为标签，这个责任不是基层员工的问题，更多的是掌握足够多社会资源的人，思想能力不足导致内耗过多导致没办法往更高级的一步发展导致的。

# 2.从何处开始
建筑业有一个术语，绿地项目和棕地项目。绿地项目基本使用的土地原来就是农田空地那种未被开发过的土地。而棕地项目是在原来工业土地。这种土地可能存在土地污染，还有拆迁的问题。

中国过去三十年都是搞大基建，但是很多新城区都是占用城郊的农田盖起来的而不是去拆迁旧城。就是因为在新的土地上没有历史问题，而在已经建设过的土地上，之前存在的各种社会利益关系纠葛非常麻烦。

而devops面临的也是类似的问题。在新项目中上自然非常方便，而很多公司里的老项目，背负大量技术债，譬如没有自动化测试，运行在无人维护的平台上等等。对于这种情况，不上devops自然不可能，但是也要讲究方式方法，毕竟不能一下子把现有的业务直接干停滞。而且虽然devops的理念在技术层面已经不算什么特别新奇的东西，但是很多公司跟多技术人员毕竟之前没有接触过，是存在偏见甚至误解的。所以切入点一定不是全面铺开，而是寻找一些独立的组件团队，展开试点，用效果逐步争取更多的支持，进而扩大影响力。转型也是存在风险的。

具体的devops转型细则，包括组件专门的团队负责转型，为所有团队成员设定可量化共同目标，小幅度改进，预留百分之20时间去减少之前欠下的技术找。这里说应对的技术债包括重构，自动化测试，非功能性需求。比如可维护性、可管理性、可拓展性、可靠性、可测试性、可部署性、可安全性等。当然这种事情对与绝大多数中国技术团队是非常困难的。他们没有远见，尤其领导。他们只会认为是你技术不行，怎么做不到在屎坑上继续加功能呢？那么后面出了问题呢，那更好办了，就是负责这块的员工能力不行呗，反正领导永远正确。

书里面讲了一个案例，是LinkedIn公司，他们之前开发的java单体程序十分巨大，到后面经常出现崩溃，故障难以排查，新特性难以开发等等。这个核心问题就是代码过于庞大混乱。改来改去是没有太大意义的。所以他们当时决定停止一切新特性开发，整个系统架构被重构，原来混在一起的服务被拆分出来数百个独立服务来解耦。整个部门开始改进工具，部署流程，基础设施和相关人员生产力。经过一些列的重构优化才逐步从技术债中走出来。


在中国，至少我经历的而言，几乎所有公司都特别希望把人变成螺丝钉。以各种要求，意识形态来强化这一点。因为这样方便管理。你最多只会你那一点，你就没办法掀起大浪。你再厉害，也得怪怪的听领导安排，否则你什么都做不成。而你一旦成为通才，那完了，你就在基础能力上具备协调一个团队的能力，如果你这个通才能力还强，整个团队就没啥人能压制你。就很容易形成自下而上的组织结构。而中国的土壤就天然打压这种形式。你都自下而上组织了，领导的权力就没了，你就算能力再强，必须在领导的掌控范围内。必须接受上面领导的任命和指令。所以通才这种东西在中国天然不受待见。一个健康的团队是应该配置小部分通才和大部分专才比较合理。都是专才，整个团队协调的沟通成本太高了。

书里面把人才分为三个类型

I型人才只精通一个领域，很专业，但是对其他方向经验很少，但是这种人对于灵活和变化的态度是比较抵触的。原因也很简单，一旦发生大变化，他只精通一个领域很可能没有用武之地，而其他方向他有没有经验，更不愿意跳出舒适圈。这也非常符合中国绝大多数人一技傍身的想法。出来混社会，有一个核心技能没错的。但是错在固守在原地，不愿意去尝试新的技术新的领域。进入自己没有经验的领域都是小学生，犯错更是家常便饭，所以很多人试了一下就缩回去了。美其名曰专注一个领域。但是就我观察的现实确实绝大多数人，即使只一直干一个领域也没见的多多么精湛。否则发展几十年了，还被人各种卡脖子？第二种是T型人才，就是精通一个领域，但是在其他领域也有技能和经验，也能去适应复杂多变的环境，并且去调整自己。T型人才应该是一个技术团队的大多数。在少量的确需要长时间积累才能胜任的岗位安排I型。第三种人才是E型，这种是可以同时精通多个领域，跨领域非常轻松。其实在高科技公司，任何一个复杂的高科技产品都是需要横跨多个领域的。固然不能要求所有的员工都具备这种横跨多个领域的能力。但是得选择做事情能力强，学习能力强的人往E型人才方向培养。这种是高潜人才。真正的创新往往也是这种人搞出来的。而I型人才是辅助，T型人才是干活主力。

当前不论是求职也好，还是公司出去融资，往往都是强调自己有多少经验，深耕多少年，但是这真的有那么重要么？如果一直把关注点放在经验到底重不重要是永远说不清楚的。就我自己的观察，大部分人大部分时间都是垃圾时间，并不能产生多么有价值的经验。而且就算有经验，经验基本都是在初期凸显的价值比较大，越往后，经验带来的产出价值越低。所以过分强调经验是不合理的。我就看过不少高科技领域所谓的专家教授行业大拿出来创业，说自己有多少经验，结果进去一看他们的产品，尤其是从研发技术层面去审查他们的代码流程，很多时候业余的像是闹着玩一样，完全不是他们口中宣传那么有经验的样子。号称有经验的太多，但是基本一到实操，才能看出到底所谓的经验到底有多少含金量。所以相比于经验这种不太好验证的东西，不如看一下一个团队面对困难的流程和决策，他们如何分析问题，如何解决问题，很多时候问题是没办法一次性解决，甚至会遭遇失败，如何快速反馈，调整策略，这才能看出来一个人或者一个团队的真正成色。


在一个大团队中，内部有不同的部分，协调沟通的成本巨大。所以控制团队的规模是非常重要的。整个devops的目标都是帮助去构建高效的组织和产品。但是人太多，什么好的策略都会失效。就会造成劣币驱逐良币，只要组织规模大了都会这样。

在一个完整得劲技术团队，产品算法研发测试运维一般都是分属于不同部门的。书中建议将运维融入整个技术团队。这个建议要看实际情况而定，不是说一定要这么做的。就我经历而言，如果devops基建建设的完备，除了项目前期可能需要运维介入支持，等一切稳定了后面大部分时间运维不在团队里也没啥问题。书中建议运维进入团队，更多是的提醒读者要重视运维，不要等到最后部署的时候出一堆问题才想起来他们。

# 3.流动的技术实践

主要就是更细化的讲解devops各部流动起来的具体做法和一些原则。

这里面建议按照需求搭建开发环境、测试环境、生产环境。别看这个很基础，我所在的很多公司，真的都没搞明白这些。开发环境第三方库版本配置一塌糊涂，甚至都没有测试环境，自己拿手测试一下就发布出去了。毫无规范可言。测试环境和生产环境严格来讲也不是一致的。因为生产环境力求稳定，可能版本更新没有开发和测试环境新。书里面建议建立统一代码库，这个我所在的绝大多数公司是可以做到的，就弄个服务器或者买个云服务，部署gitlab。但是也真有连gitlab都没有的公司，完全不做代码版本的管理。非常草台班子。这个公司都好多年了，竟然还活着。这种环境的配置，其实非常契合容器的设计目的。但是除了我自己在家里写自己的项目，或者一些写python的在ide里面有隔离，很多在公司里面都没有做环境隔离和配置。这块互联网大厂做的的确是非常规范。

快速可靠的自动划测试是保障研发写出来的代码能够比较可靠的最基本的手段。不幸的是，我在很多国内企业工作发现大多数情况下，压根没有单元测试。更不要提涉及到代码覆盖率的高密度测试和专门去测试代码和算法边界了。这种问题在谷歌也大面积出现过。比如代码不经过测试直接流入到生产环境。各个团队更改的代码互相冲突，新人进来压根不敢更改代码。老手也不敢改，大家都知道这个状态的代码谁改谁背锅。稍微多一点的改动一定会改出来严重bug。这种事情我在国内也见到过。谷歌的做法是加入大量自动化测试，搭建专门的流水线进行测试，设置测试覆盖率指标，编写测试规范和指南，让团队所有人都照章执行。现在谷歌的程序员只要提交代码就会出发自动化测试，只有通过成千上万的自动化测试用例吗，代码才会被提交到主干。

在代码提交到版本管理系统后，会自动进行构建，打包等一系列操作，这些都是用shell脚本或者其他脚本(python,lua等)控制自动化执行的。构建完还会进行静态代码测试，重复代码检查，代码风格检查，代码重复检查等一系列监测。之后进入自动化单元测试，后面还会经过测试人员手动的探索性测试，用户验收性的手动测试，预生产阶段的手动测试，最后进入生产环境，这时候测试人员还会进行手动测试。所有的操作都会保留记录和痕迹，可以帮助相关人员明确责任以及排查问题。

测试从顺序来讲分为单元测试、验证测试、集成测试。其中单元测试是程序员自己做。测试函数对于给定输入返回预期值。验收测试则是测试整体应用。二者区别在于单元测试是验证满足程序员预期而验证测试是测试满足客户预期。集成测试是除了本软件，还要加上其他应用和服务。验收测试与集成测试的区别是验收测试对于一些外部调用可以使用模拟信息，而集成测试就是使用实际真实数据进行测试。

自动化测试部分因为编写好测试用例之后是自动触发执行的，而自动化本身就为了快速发现问题，所以能并行尽量并行，这样可以大大缩短反馈时间。这里有一个开发范式，就是测试驱动开发。它的意思是说对代码做出变更之前，先写测试用例。然后再编写代码，并让代码通过测试。

上面说的测试除了自动化测试部分，也包括手动测试部分。而手动测试部分应该尽可能改进成自动化测试，这样可以极大提高效率。而测试人员应该投入更多的时间去优化测试流程和进行高价值的探索性测试。

在自动化测试中，还可以集成性能测试。因为很多性能问题如果不加在自动化测试中，就只能等到使用的时候才会显现出来，甚至会出现偶发问题，既影响用户体验，又不便于排查。而在自动化测试中加入性能测试十分方便。只要集成部分针对部门函数和组件的性能测试用例即可。

相关流水线建立完成了，一旦发现问题，就要快速修复，否则建立这套devops系统就没有意义了。

持续集成是说开发软件不同版本会把代码放在不同分支，如果所有分支都独立的去开发，后面就没法合并，与此同时，维护相当多的分支，本身也非常消耗精力。所以要小修改，修改完就提交，代码提交后就对软件进行打包进行后续一系列测试，如果在构建打包过程中出现问题，就立刻暂停手中工作。把构建问题解决掉。而所有的开发都放在主分支上。这么做的核心保证就是必要要有自动化测试，且自动化测试要建设的比较完备，都则这么弄出来的代码就是一堆垃圾。小批量开发是重要手段，将一个大的代码改动差分成多个小改动，并明确每次改动的目标进行改动。改动好一次就提交，进行测试。没问题再进行下一次改动。

在代码通过测试后，就要进行部署了。软件的部署需要配置软件执行的环境，如果涉及多个服务之间互相通信，还要完成整体多个服务的更新。手动部署不仅效率低，而且因为操作繁琐，很容易出现各种问题，从而影响部署效率。所以书中推荐部署自动化和低风险化。每天都可以部署，所有人都可以触发部署，连狗都可以。

将部署与发布解耦。发布是面向客户使用的，是直接把服务提供给客户。而部署不一定直接把服务提供给客户。

发布有两种模式，一种是基于环境的发布模式，一种是基于应用的发布模式。基于环境的发布模式是说设置两个环境蓝绿环境，蓝色环境是当前给用户提供服务的环境，而绿色环境是后面准备上线的新环境。那么在绿色环境测试完成没问题后，将二者进行替换。原来的绿色环境变为蓝色环境，而原来的蓝色环境会被部署新的环境成为绿色环境进行测试。

这里面有一个变种是金丝雀发布模式。就是环境分为三个，一个是给研发内部使用，一个是给小量用户使用，一个是给绝大多数用户使用。一旦在内部或者下批量用户环境出现问题，立刻版本回退，并且排查问题。

基于应用的发布模式，实际上就是用开关组件，相关特性部署在实际环境中，但是只是在后台计算相关结果进行测试，并不会将结果给客户看到。等到测试完全，没啥问题，在打开开关，提供给用户使用。这种适合一些互联网后端应用，因为再怎么模拟测试，也没办法模拟实际环境大量并发情况。而且即使是部署到实际环境，也是逐步提升使用新特性用户比例，先是小范围测试，没什么问题再逐步扩大范围。

软件的技术架构不是一成不变的。而是伴随着企业发展的新的需求进行演化的。几乎所有的it大公司都经历过这个过程，甚至整体的架构经历了数次变更。比如亚马逊早期的服务是单体后端程序，这在企业初期是非常合适的。但是随着产品规模增加，变得越来越重，且越来越难以更改，后面做了前后端分离，好了一些。但是随着业务代码越来越多，部署测试的效率再度大幅下降。随后改成微服务架构。这里面虽然说的是web后端服务的例子，但是实际上任何it技术演化都要伴随这种架构的演化。架构的演化的目的也为为了业务产品可以更快更有效地部署发布。

# 4.反馈的技术实践
怎么样才能在代码上传到代码库触发后续一系列测试部署发布的过程中快速反馈问题，甚至去探索一些业务上的改进方向呢?

前面提到的各种自动化测试套件是基础手段，但是这还不够，需要在此基础上构建遥测系统。遥测系统分为多个层次，它可以帮助我们监测甚至分析出缺陷的原因，帮助我们快速定位问题。因为大型软件都是分为多个团队开发的，一旦出了问题，而没有完善的遥测系统，就很容易形成推诿甩锅等问题。而一旦有了完善的遥测系统，什么问题都很客观清晰。遥测系统需要监控软件多个层析的数据和状态信息，甚至还要监控软件运行的环境信息，收集各个层次的数据，它会让所有人都很方便的确定系统什么时候发生了什么事情，情况到底怎么样，而不是两眼一抹黑瞎猜。其中包括转存各个层次的日志，还有一些辅助软件框架，在代码中内嵌一些代码传递系统内部状态变化信息到遥测监控系统，而完善的遥测系统，不仅可以收集各种日志信息，系统事件日志信息，还可以对很多信息进行进一步挖掘，去发现产品的缺陷或者改进空间。而不论是产品、研发、测试、运维，都可以通过遥测系统快速去查看系统运行状态。完善的遥测系统不是一开始就天然存在的，而是要不断总结分析，去不断完善的。这就是我前面说的，一个团队必须是学习型创新型才可能去做这种事情，而牛马型既没有时间也缺乏意愿去做这种改进。

有了遥测数据，就可以根据遥测数据设置各种评价系统能力状态的指标和探索分析产品的进一步改进方向，分析的方法可以使统计学，也可以是各种基于统计学的书中没有提的一些技术，比如数据挖掘，机器学习，数学建模等等。

很多开发完成产品要求的feature就写自动化测试代码和业务代码，提交完没报什么bug就认为完事了。但是任何feature实际都是为了客户服务的，也许现在的产品在部署或者使用并不方便。很多研发就觉得这不是自己的责任了，是产品和运维的活。但是如果研发更够去花一些时间深入看一下部署是否琐碎困难，使用是否蹩脚，也许就可以对如何实现功能有更合理的改进方法。

这也就是说，虽然一个团队分工不同，但是最终的产品价值是呈现的产品里面的。一个能够关注并且可以反馈出改进方案的成员所创造的价值是远远多余按部就班只局限在自己要求范围内工作的员工的，这涉及的是团队文化建设，在劣质的团队文化中，就算有这样优秀的员工，也会被各种怕脏水背锅，最后被排挤走，而产品就像得了癌症，一步一步被员工榨干，最后产品投入高盈利差，被消费者抛弃。团队鸡飞狗跳裁员。这是我在中国几乎所有高科技企业看到的。

A/B测试就是说给用户呈现两种产品形态，这背后是用一些程序开关控制，通过对照来分析那些特性是对于产品发展可以提升竞争力的，那些不是。然后去裁撤没用的功能。而我在中国使用大量互联网产品，感受就是每个APP都是一个大杂烩，一个美团购物软件也要直播，甚至还有游戏。抖音视频软件，也做购物，设置还搞游戏、网贷。反正大家互相抄来抄去。产品经理没有脑子，就知道抄。知乎一个接收消息的按钮五年内变来变去，越来越难用，几年后又回退回去了，你这产品经理是脑袋进屎了？然后开发就按照产品要求改来改去，大家都是刷存在感而已。至于产品早就烂了。

书里面反馈的最后一部分说的是代码评审，这个用过github或者gitlab或者类似的代码管理软件都有评审功能。反正就是鼓励小批量提交审核，甚至可以做结对编程，一个写测试用例，一个写业务代码，互相审查，因为距离问题最近的人才是最了解问题的人。尽量缩短官僚化和压根不了解这块业务的人评审这块的事情。

# 5.持续学习与实验的技术实践
书里面建议将学习融入到日常工作，但是大量的中国科技公司却告诉员工给你发工资来上班是来创造价值的不是来让你学习的。没有任何人能万分之记住之前接受教育的内容，也灭有任何人能仅仅凭借之前接受的教育就能完全胜任科技研发的工作，大家都需要学习，但是我在很多公司发现，在所谓的科技公司，是不能在工作时间看书的。但是有时候就是要查资料啊，老板看到员工在上班时间看书(这里的书是跟工作相关的技术书籍而不是什么乱七八糟完全不相关的书籍)跟吃了屎一样难受，估计也就看到员工准点下班比这个更能让老板们难受。这种风气怎么可能让你在工作中学习呢？老板们都是希望不需要培训上来就直接干活，干完活在试用期直接开掉，已经没有利用价值了。怎么可能让你学习呢？

至于员工学习成长也好，组织架构或者技术架构演化也好，老板们从来不关心。写bug就加班改，什么体系不体系的？员工是牛马耗材，为什么要让员工学习？公司不是学校。反正这总中华田园风格的事情很多。甚至员工上厕所都要计时。这种事情只会在低人权。但凡人权保护正常一点，哪里能容得下这么胡搞？

但是这些老板都可以赚很多钱，尤其是给ToG的业务，那真是赚的盆满钵满。如果在一个相对公平的市场，消费者权益可以得到相对公平的保护，这么搞的产品谁愿意用呢？说明市场是畸形的。

想让组织转变为学习型组织，最关键的一部就是保证公平。如果基本的公平得不到保证，一旦出了问题，让不相关人员背锅，谁又愿意跟大家分享踩过的坑呢？谁又想着让组织团队发展的更好更有竞争力呢？而维护公平最简单的一个手段就是信息公开透明。在一些地方，连法律审判都不敢公开出来视频，那法官岂不是想怎么胡作非为就怎么乱搞，哪有公平可言呢？连古代审案都让大众去旁边观看，这些地方到底退化成什么样子了呢？就这种环境，怎么可能孕育出学习型组织呢？

书中说的将局部知识转化为全局改进，就是说一些文档，把经常重复的事情尽量改成自动化，jira之类的东西，这些在国内绝大多数科技公司是已经能做到的，至少基础设施层面是不缺的。因为这本书写的时候是十多年前，所以这块整体国内不存在短板。

预留组织学习和改进的时间，在国内老板看你准点下班都难受的不行的情况下，基本就是一股清流。我以前在一家医疗机器人公司，每周技术分享还不能占用正常工作时间，得下班之后跟贼似的自己私下偷偷开。这还是号称高科技呢。方法虽然好，但是在这片贫瘠土地上是难以生根发芽。就这还跑出去要跟人家打科技战呢？

# 6.集成信息安全、变更管理、合规性技术实践

这个地方主要是跟网络安全结合。毕竟核心数据代码泄露了，你效率越高损失越大。这些安全套件也是要嵌入到devops平台。字节跳动就出现实习生在代码里面投毒的问题，还能去参加排查会议针对性攻击，这就是安全建设不到位，权限管理代码审查等同于失效。除了行为规范，也要加入一些软件工具，比如静态代码扫描，动态代码分析，二进制分析是否存在病毒或者恶意代码。

开发工程师在开发的时候不可避免会引入第三方库，有的库甚至没有源代码，这种就会带来安全隐患，这就涉及软件供应链安全问题。对信息安全要求高的，需要专门对软件供应链软件和代码进行审核。

要保证所有操作都能保留证据，这是排查所有问题并且进行改进的前提。


# 7.总结

再好的体系，也需要人去实践。再好的体系也会存在过时的问题，最好的体系就是针对当前问题，以相对小的代价解决核心问题。虽然书里面介绍了很多原则和方法，但是如果执行的人不合适，也都会沦为机械官僚的执行。所以选择有相同目标且能力匹配的人是做一些事情的前提。找到合适的人，困难怎么来就怎么解决。一切手段都是为了最主要的目标服务的。切记不要过于迷信任何体系和技术。什么都会变，唯一不变的是目标和勇敢改变世界的心！











